<!doctype HTML>
<html>
  <head>
    <title>Patker Chat</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <script src="socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
const socket = io();

const id = Math.floor(Math.random() * 10000000);
socket.emit("id", id);
const input = $('.input_box');
const chat = $('.chat_box');

String.prototype.replaceAll = function(str1, str2, ignore)
{
    return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
}

function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };

  return emotify(text.replace(/[&<>"']/g, function(m) { return map[m]; }));
}

function emotify(string){
  emotes = ["Kappa", "Ogre", "Spiffy", "Nerd", "Ryab", "StarWarsExpert", "Gersoxl", "Patker", "Porker", "Parkour", "Dude", "IDK", "Horse", "Peanut", "Panda", "BTC", "Idiot",
  "MadCauseBad", "Why"];
  let matches = [];
  const regex = /--*(\w{2,}|[a-z])/g;
  $.each(emotes, function(index, emote){
    let classes = [];
    let matches = [];
    let m;
    while ((m = regex.exec(string)) !== null) {
        if (m.index === regex.lastIndex) {
            regex.lastIndex++;
        }
        m.forEach((match, groupIndex) => {
            if(matches.indexOf(match) == -1 && groupIndex == 1){
              matches.push(match);
            }
        });
    }

    if(string.indexOf(emote) > -1){
      console.log(emote + " " + matches.toString());
      if(matches.indexOf("s") > -1 || matches.indexOf("spin") > -1){
        classes.push('spin');
      }
      if(matches.indexOf('f') > -1 || matches.indexOf("flip") > -1){
        classes.push('flip');
      }
      if(matches.indexOf('r') > -1 || matches.indexOf('rainbow') > -1){
        classes.push('rainbow');
      }
      if(matches.indexOf('c') > -1 || matches.indexOf('contrast') > -1){
        classes.push('contrast');
      }
      if(matches.indexOf('g') > -1 || matches.indexOf('sad') > -1){
        classes.push('sad');
      }
      if(matches.indexOf('w') > -1 || matches.indexOf('wacky') > -1){
        classes.push('wacky');
      }
      if(matches.indexOf('b') > -1 || matches.indexOf('spooky') > -1){
        classes.push('spooky');
      }
      console.log(classes.toString());
      classes = classes.toString().replaceAll(',', ' ');
      console.log(classes);
      console.log(matches.toString());
      matches = "-"+matches.toString().replaceAll(",", "-");
      console.log(matches);
      console.log(emote+matches);
      string = string.replaceAll(`:${emote}${matches}`, `<img src="emotes/${emote}.png" style="width: 2rem; height: 2rem;" class="${classes}" />`);
      string = string.replace(":Spiffy", "butt");
    }
  });

  return string;
}

function sendMessage(){
  let message = $('.input_box').val();
  socket.emit("message",
    {"id": id, "message": message}
  );
  $('.input_box').val("");
}

$(document).keypress(function(e){
  if(e.which == 13 && $('.input_box').is(":focus")){
    e.preventDefault();
    sendMessage();
  }
});

socket.on("return", (json)=>{
  let message = escapeHtml(json["id"] + ": " + json['message']);
  if(json['message'] != '' && json['message'] != ' '){
    if(json['id'] == id){
      $('.chat_box').append(`<p class="chat" style="color: blue">${message}</p>`);
    }else{
      $('.chat_box').append(`<p class="chat">${message}</p>`);
    }
  }

});

    </script>
    <div align="center" class="chat_box_wrapper">
      <div class="chat_box_back">
        <div class="chat_box">

        </div>
      </div>
      <textarea class="input_box"></textarea>
      <br />
      <button onClick="sendMessage();" class="button">send</button>
    </div>
  </body>
</html>
