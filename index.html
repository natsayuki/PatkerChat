<!doctype HTML>
<html>
  <head>
    <title>Patker Chat</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <script src="socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
const socket = io();

const id = Math.floor(Math.random() * 10000000);
socket.emit("id", id);
const input = $('.input_box');
const chat = $('.chat_box');

String.prototype.replaceAll = function(str1, str2, ignore)
{
    return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
}

function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };

  return emotify(text.replace(/[&<>"']/g, function(m) { return map[m]; }));
}

function emotify(string){
  emotes = ["Kappa", "Ogre", "Spiffy", "Nerd", "Ryab", "StarWarsExpert", "Gersoxl", "Patker", "Porker", "Parkour", "Dude", "IDK", "Horse", "Peanut", "Panda", "BTC"];
  $.each(emotes, function(index, emote){
    string = string.replaceAll(`:${emote}-s`, `<div class="emote spin" style="width: 2rem; height: 2rem; background: url('emotes/${emote}.png'); background-size: 2rem;"></div>`);
    string = string.replaceAll(`:${emote}--spin`, `<div class="emote spin" style="width: 2rem; height: 2rem; background: url('emotes/${emote}.png'); background-size: 2rem;"></div>`);
    string = string.replaceAll(`:${emote}-f`, `<div class="emote flip" style="width: 2rem; height: 2rem; background: url('emotes/${emote}.png'); background-size: 2rem;"></div>`);
    string = string.replaceAll(`:${emote}--flip`, `<div class="emote flip" style="width: 2rem; height: 2rem; background: url('emotes/${emote}.png'); background-size: 2rem;"></div>`);
    string = string.replaceAll(`:${emote}`, `<div class="emote" style="width: 2rem; height: 2rem; background: url('emotes/${emote}.png'); background-size: 2rem;"></div>`);
  });
  return string;
}

function sendMessage(){
  let message = $('.input_box').val();
  socket.emit("message",
    {"id": id, "message": message}
  );
  $('.input_box').val("");
}

$(document).keypress(function(e){
  if(e.which == 13 && $('.input_box').is(":focus")){
    e.preventDefault();
    sendMessage();
  }
});

socket.on("return", (json)=>{
  let message = escapeHtml(json["id"] + ": " + json['message']);
  if(json['message'] != ''){
    if(json['id'] == id){
      $('.chat_box').append(`<div class="message_wrap"><p class="chat" style="color: blue;">${message}</p></div><br />`);
    }else{
      $('.chat_box').append(`<div class="message_wrap"><p class="chat">${message}</p></div><br />`);
    }
  }

});

    </script>
    <div align="center" class="chat_box_wrapper">
      <div class="chat_box_back">
        <div class="chat_box">

        </div>
      </div>
      <textarea class="input_box"></textarea>
      <br />
      <button onClick="sendMessage();" class="button">send</button>
    </div>
  </body>
</html>
