<!doctype HTML>
<html>
  <head>
    <title>Patker Chat</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <script src="socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
const socket = io();

const id = Math.floor(Math.random() * 10000000);
socket.emit("id", id);
const input = $('.input_box');
const chat = $('.chat_box');

$(document).ready(function(){
  $('.input_box').focus();
  $(document).on('mousemove', function(e){
    $('.hover_tag').css({
       left:  e.pageX,
       top:   e.pageY - ($('.hover_tag').height() + 4)
    });
  });
  $('.chat_box').on('mouseenter', '.emote', function(){
    let emote = $(this).attr('emote');
    let tags = $(this).attr('tags');
    $('.hover_tag').html('<p>:'+emote+tags+'</p>');
    console.log($('.hover_tag').height() + 4)
  });
  $('.chat_box').on('mouseleave', '.emote', function(){
    $('.hover_tag').html('');
  });
});

String.prototype.replaceAll = function(str1, str2, ignore)
{
    return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
}

function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };

  return emotify(text.replace(/[&<>"']/g, function(m) { return map[m]; }));
}

function emotify(string){
  emotes = ["Kappa", "Ogre", "Spiffy", "Nerd", "Ryab", "StarWarsExpert", "Gersoxl", "Patker", "Porker", "Parkour", "Dude", "IDK", "Horse", "Peanut", "Panda", "BTC", "Idiot",
  "MadCauseBad", "Why"];
  let matches = [];
  const regex = /-[sfrcgwb]/g;
  $.each(emotes, function(index, emote){
    let classes = [];
    let matches = [];
    let m;
    while ((m = regex.exec(string)) !== null) {
        if (m.index === regex.lastIndex) {
            regex.lastIndex++;
        }
        m.forEach((match, groupIndex) => {
            if(matches.indexOf(match) == -1 && groupIndex == 0){
              matches.push(match);
            }
        });
    }

    if(string.indexOf(emote) > -1){
      classes = matches.toString()
      .replaceAll("-s", "spin ")
      .replaceAll("-f", "flip ")
      .replaceAll("-r", "rainbow ")
      .replaceAll("-c", "contrast ")
      .replaceAll("-g", "sad ")
      .replaceAll("-w", "wacky ")
      .replaceAll("-b", "spooky")
      .replaceAll(',',' ');
      matches = matches.toString().replaceAll(',','');
      string = string.replaceAll(`:${emote}${matches}`, `<img src="emotes/${emote}.png" class="emote ${classes}" tags="${matches}" emote="${emote}" />`);
    }
  });

  return string;
}

function sendMessage(){
  let message = $('.input_box').val();
  socket.emit("message",
    {"id": id, "message": message}
  );
  $('.input_box').val("");
}

$(document).keypress(function(e){
  if(e.which == 13 && $('.input_box').is(":focus")){
    e.preventDefault();
    sendMessage();
  }
});

$(document).keypress(function(e){
  if(e.which == 102){
    $('.input_box').focus();
  }
});



socket.on("return", (json)=>{
  let message = escapeHtml(json["id"] + ": " + json['message']);
  if(json['message'] != '' && json['message'] != ' '){
    if(json['id'] == id){
      $('.chat_box').append(`<p class="chat" style="color: blue">${message}</p>`);
    }else{
      $('.chat_box').append(`<p class="chat">${message}</p>`);
    }
  }

});

    </script>
    <div align="center" class="chat_box_wrapper">
      <div class="chat_box_back">
        <div class="chat_box">

        </div>
      </div>
      <textarea class="input_box"></textarea>
      <br />
      <button onClick="sendMessage();" class="button">send</button>
    </div>
    <div class="hover_tag"></div>
  </body>
</html>
