<!doctype HTML>
<html>
  <head>
    <title>Patker Chat</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <script src="socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
const socket = io();

const id = Math.floor(Math.random() * 10000000);
socket.emit("id", id);
const input = $('.input_box');
const chat = $('.chat_box');

emotes = ["Kappa", "Ogre", "Spiffy", "Nerd", "Ryab", "StarWarsExpert", "Gersoxl", "Patker", "Porker", "Parkour", "Dude", "IDK", "Horse", "Peanut", "Panda", "BTC"
, "MonkaHyper", "Brit", "GnomeChild", "SurprisePatker"];

function beamit(socket, back, message){
  socket.emit(back, message);
  socket.broadcast.emit(back, message);
}

$(document).ready(function(){
  $.each(emotes, function(index, emote){
    $('.emote_list').append(`<img src="emotes/${emote}.png" class="emote preview" tags="" emote="${emote}" previewType="emote" />`)
  });
  $('.emote_list').append(`
    <h1>Animation Tags</h1>
    <img src="emotes/Patker.png" class="emote preview spin" tags="" emote="Spin" previewType="animation_tag" tag="-s" />
    <img src="emotes/Patker.png" class="emote preview flip" tags="" emote="Flip" previewType="animation_tag" tag="-f" />
    <img src="emotes/Patker.png" class="emote preview rainbow" tags="" emote="Rainbow" previewType="animation_tag" tag="-r" />
    <h1>Color Tags</h1>
    <img src="emotes/Patker.png" class="emote preview contrast" tags="" emote="Contrast" previewType="color_tag" tag="-c" />
    <img src="emotes/Patker.png" class="emote preview sad" tags="" emote="Sad" previewType="color_tag" tag="-g" />
    <img src="emotes/Patker.png" class="emote preview wacky" tags="" emote="Wacky" previewType="color_tag" tag="-w" />
    <img src="emotes/Patker.png" class="emote preview spooky" tags="" emote="Spooky" previewType="color_tag" tag="-b" />
  `)
  $('.input_box').focus();
  $(document).on('mousemove', function(e){
    $('.hover_tag').css({
       left:  e.pageX,
       top:   e.pageY - ($('.hover_tag').height() + 4)
    });
  });
  $(document).on('mouseenter', '.emote', function(){
    let emote = $(this).attr('emote');
    let tags = $(this).attr('tags');
    $('.hover_tag').html('<p>:'+emote+tags+'</p>');
    $('.hover_tag').attr('emote', ':'+emote+tags);
  });
  $(document).on('mouseleave', '.emote', function(){
    $('.hover_tag').html('');
  });
  $('.chat_box').on('dblclick', '.chat', function(){
    if($('.hover_tag').width() > 0){
      console.log($('.hover_tag').attr('emote'));
      $('.input_box').val($('.input_box').val() + $('.hover_tag').attr('emote'));
    }
    else{
      let thisId = $(this).attr('thisId');
      $('.input_box').val(`:whisper(${thisId})`);
    }
    $('.input_box').focus();
  });
  $(document).on('dblclick', '.preview', function(){
    if($(this).attr('previewType') == 'emote'){
      $('.input_box').val($('.input_box').val() + $('.hover_tag').attr('emote'));
    }
    else{
      $('.input_box').val($('.input_box').val() + $(this).attr('tag'));
    }
  });
  $(document).on('mousedown', '.chat', function(e){
    if(e.which == 3){
      $('.input_box').val($('.input_box').val() + `@` + $(this).attr('thisid'))
      $('.input_box').focus();
    }
  });
  $(document).on('contextmenu', '.chat', function(e){
    e.preventDefault();
  });
  $('.emote_list_button').click(function(){
    $('.emote_list').toggle();
  });
  $('#query').onClick(function(){
    console.log('clicked');
  });

});


String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.split(search).join(replacement);
};

function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  text = emotify(text.replace(/[&<>"']/g, function(m) { return map[m]; }));
  return text;
}

function emotify(string){
  const emoteRegEx = emotes.join('|');
  const regex = new RegExp(`:(${emoteRegEx})(-[sfrcgwb](-[sfrcgwb])?)`, 'g');
  const match = string.match(regex);
  matches = [];
  if(match){
    for(result of match){
      matches.push(result);
    }
    $.each(matches, function(index, item){
      console.log(item);
      const tags = item.substring(item.indexOf('-'),item.length);
      const emote = item.substring(1, item.indexOf('-'));
      console.log('emote: ' +emote + ' tags: ' + tags);
      classes = tags
      .replaceAll("-s", " spin ")
      .replaceAll("-f", " flip ")
      .replaceAll("-r", " rainbow ")
      .replaceAll("-c", " contrast ")
      .replaceAll("-g", " sad ")
      .replaceAll("-w", " wacky ")
      .replaceAll("-b", " spooky");
      console.log(classes);
      const finder = new RegExp(`${item}(?!-[sfrcgwb])`);
      string = string.replaceAll(finder, `<img src="emotes/${emote}.png" class="emote ${classes}" tags="${tags}" emote="${emote}" />`);
      console.log('here');
    });

  }
  $.each(emotes, function(index, emote){
    string = string.replaceAll(`:${emote}`, `<img src="emotes/${emote}.png" class="emote" tags="" emote="${emote}" />`)
  });
  return string;
}

function sendMessage(){
  let message = $('.input_box').val();
  if(message.substring(0, 8) == ':whisper'){
    const regex = /:whisper[(][0-9]{1,8}[)]/g;
    const str = message;
    let m;

    while ((m = regex.exec(str)) !== null) {
      // This is necessary to avoid infinite loops with zero-width matches
      if (m.index === regex.lastIndex) {
          regex.lastIndex++;
      }

      // The result can be accessed through the `m`-variable.
      const regex1 = /[(][0-9]{1,8}[)]/g;
      const str1 = m[0];
      let m1;

      while ((m1 = regex1.exec(str1)) !== null) {
          // This is necessary to avoid infinite loops with zero-width matches
          if (m1.index === regex1.lastIndex) {
              regex1.lastIndex++;
          }

          // The result can be accessed through the `m`-variable.
          let to = m1[0].replaceAll(')', '').replaceAll('(', '');
          console.log(to);
          let toMessage = message.replace(m[0], '');
          console.log(toMessage);
          socket.emit('whisper', {'to': to, 'from': id, 'message': toMessage})
      }
    }
  }
  else{
    socket.emit("message",
      {"id": id, "message": message}
    );
  }

  $('.input_box').val("");

}

$(document).keypress(function(e){
  if(e.which == 13 && $('.input_box').is(":focus")){
    e.preventDefault();
    sendMessage();
  }
});

$(document).keypress(function(e){
  if(e.which == 102){
    $('.input_box').focus();
  }
});

socket.on("returnWhisper", (json)=>{
  console.log(json['from']);
  if(json['from'] == id){
    let messageId = json['to'];
    let message = escapeHtml(`to ${json['to']}: ${json['message']}`);
    $('.chat_box').append(`<p class="chat" style="color: grey" thisId="${messageId}">${message}</p>`);
  }
  if(json['to'] == id){
    let messageId = json['from'];
    let message = escapeHtml(`from ${json['from']}: ${json['message']}`);
    $('.chat_box').append(`<p class="chat" style="color: grey" thisId="${messageId}">${message}</p>`);
  }
});

socket.on("return", (json)=>{
  let message = escapeHtml(json["id"] + ": " + json['message']);
  if(json['message'] != '' && json['message'] != ' '){
    let messageId = json['id'];
    if(json['id'] == id){
      $('.chat_box').append(`<p class="chat" style="color: blue" thisId="${messageId}">${message}</p>`);
    }else{
      if(json['message'].indexOf(`@${id}`) != -1){
        $('.chat_box').append(`<p class="chat" style="color: yellow;" thisId="${messageId}">${message}</p>`);
      }
      else{
        $('.chat_box').append(`<p class="chat" thisId="${messageId}">${message}</p>`);
      }
    }
  }
});
    </script>
    <input type='text' id='username'/>
    <input type='text' id='password' />
    <div class="query" style="width: 50px; height 50px; background-color: blue">
      <p>query pls work</p>
    </div>
    <div align="center" class="chat_box_wrapper">
      <div class="chat_box_back">
        <div class="chat_box">

        </div>
        <div class="emote_list">
          <h1>Emotes</h1>
        </div>
      </div>
      <textarea class="input_box"></textarea>
      <div class="emote_list_button">

      </div>
      <br />
      <button onClick="sendMessage();" class="button">send</button>
    </div>
    <div class="hover_tag" emote=""></div>
  </body>
</html>
